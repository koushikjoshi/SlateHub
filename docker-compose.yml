services:
    slatehub:
        build:
            context: ./server
            dockerfile: Dockerfile
        container_name: slatehub-server
        restart: unless-stopped
        ports:
            - "${BIND_IP:-127.0.0.1}:${SERVER_PORT:-3000}:3000"
        environment:
            - SERVER_HOST=0.0.0.0
            - SERVER_PORT=3000
            - ENVIRONMENT=${ENVIRONMENT:-production}
            - RUST_LOG=${RUST_LOG:-info,slatehub=debug,tower_http=debug}
            - LOG_FORMAT=${LOG_FORMAT:-pretty}
            # Database
            - DATABASE_URL=${DATABASE_URL:-}
            - DB_HOST=surrealdb
            - DB_PORT=${DB_PORT:-8000}
            - DB_USERNAME=${DB_USER:-root}
            - DB_PASSWORD=${DB_PASS:-root}
            - DB_NAMESPACE=${DB_NAMESPACE:-slatehub}
            - DB_NAME=${DB_NAME:-main}
            # Storage (generic S3 interface)
            - S3_ENDPOINT=${S3_ENDPOINT:-http://rustfs:9000}
            - S3_ACCESS_KEY=${S3_ACCESS_KEY:-admin}
            - S3_SECRET_KEY=${S3_SECRET_KEY:-password}
            - S3_BUCKET=${S3_BUCKET:-slatehub}
            - S3_REGION=${S3_REGION:-us-east-1}
            # Secrets
            - JWT_SECRET=${JWT_SECRET:-}
            - SESSION_SECRET=${SESSION_SECRET:-}
            # Email
            - MAILJET_API_KEY=${MAILJET_API_KEY:-}
            - MAILJET_API_SECRET=${MAILJET_API_SECRET:-}
            - MAILJET_FROM_EMAIL=${MAILJET_FROM_EMAIL:-}
            - MAILJET_FROM_NAME=${MAILJET_FROM_NAME:-}
        depends_on:
            surrealdb:
                condition: service_healthy
            rustfs:
                condition: service_healthy

    surrealdb:
        image: surrealdb/surrealdb:v3.0.1
        container_name: slatehub-surrealdb
        restart: unless-stopped
        user: "${UID:-1000}"
        ports:
            - "${BIND_IP:-127.0.0.1}:${DB_PORT:-8000}:8000"
        volumes:
            - ./db/data:/data
        command: start --log info --user ${DB_USER:-root} --pass ${DB_PASS:-root} rocksdb://data/database.db
        healthcheck:
            test: ["CMD", "surreal", "isready"]
            interval: 10s
            timeout: 5s
            retries: 15
            start_period: 20s

    rustfs:
        image: rustfs/rustfs:latest
        container_name: slatehub-rustfs
        restart: unless-stopped
        ports:
            - "${BIND_IP:-127.0.0.1}:9000:9000"
            - "${BIND_IP:-127.0.0.1}:9001:9001"
        volumes:
            - ./db/files:/data
        environment:
            - RUSTFS_VOLUMES=/data
            - RUSTFS_ADDRESS=0.0.0.0:9000
            - RUSTFS_CONSOLE_ADDRESS=0.0.0.0:9001
            - RUSTFS_CONSOLE_ENABLE=true
            - RUSTFS_ACCESS_KEY=${S3_ACCESS_KEY:-admin}
            - RUSTFS_SECRET_KEY=${S3_SECRET_KEY:-password}
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "timeout 5s bash -c '</dev/tcp/127.0.0.1/9000' || exit 1",
                ]
            interval: 10s
            timeout: 5s
            retries: 8
            start_period: 15s

networks:
    default:
        driver: bridge
