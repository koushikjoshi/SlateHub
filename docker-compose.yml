version: "3.9"

services:
    slatehub:
        build:
            context: ./server
            dockerfile: Dockerfile
        container_name: slatehub-server
        restart: unless-stopped
        ports:
            - "${BIND_IP:-127.0.0.1}:${SERVER_PORT:-3000}:3000"
        environment:
            - SERVER_HOST=0.0.0.0
            - SERVER_PORT=3000
            - ENVIRONMENT=${ENVIRONMENT:-production}
            - RUST_LOG=${RUST_LOG:-info,slatehub=debug,tower_http=debug}
            - LOG_FORMAT=${LOG_FORMAT:-pretty}
            # Database
            - DATABASE_URL=${DATABASE_URL:-}
            - DB_HOST=surrealdb
            - DB_PORT=${DB_PORT:-8000}
            - DB_USERNAME=${DB_USER:-root}
            - DB_PASSWORD=${DB_PASS:-root}
            - DB_NAMESPACE=${DB_NAMESPACE:-slatehub}
            - DB_NAME=${DB_NAME:-main}
            # Storage
            - MINIO_ENDPOINT=${S3_ENDPOINT:-http://minio:9000}
            - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-admin}
            - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-password}
            - MINIO_BUCKET=${S3_BUCKET_NAME:-slatehub}
            - MINIO_REGION=us-east-1
            # Secrets
            - JWT_SECRET=${JWT_SECRET:-}
            - SESSION_SECRET=${SESSION_SECRET:-}
            # Email
            - MAILJET_API_KEY=${MAILJET_API_KEY:-}
            - MAILJET_API_SECRET=${MAILJET_API_SECRET:-}
            - MAILJET_FROM_EMAIL=${MAILJET_FROM_EMAIL:-}
            - MAILJET_FROM_NAME=${MAILJET_FROM_NAME:-}
        depends_on:
            surrealdb:
                condition: service_healthy
            minio:
                condition: service_healthy

    surrealdb:
        image: surrealdb/surrealdb:latest
        container_name: slatehub-surrealdb
        restart: unless-stopped
        user: "${UID:-1000}"
        ports:
            - "${BIND_IP:-127.0.0.1}:${DB_PORT:-8000}:8000"
        volumes:
            - ./db/data:/data
        command: start --log info --user ${DB_USER:-root} --pass ${DB_PASS:-root} rocksdb://data/database.db
        healthcheck:
            test: ["CMD", "surreal", "isready"]
            interval: 10s
            timeout: 5s
            retries: 15
            start_period: 20s

    minio:
        image: minio/minio:latest
        container_name: slatehub-minio
        restart: unless-stopped
        ports:
            - "${BIND_IP:-127.0.0.1}:9000:9000"
            - "${BIND_IP:-127.0.0.1}:9001:9001"
        volumes:
            - ./db/files:/data
        environment:
            - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
            - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-password}
        command: server /data --console-address ":9001"
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "timeout 5s bash -c '</dev/tcp/127.0.0.1/9000' || exit 1",
                ]
            interval: 10s
            timeout: 5s
            retries: 8
            start_period: 15s

networks:
    default:
        driver: overlay
        attachable: true
